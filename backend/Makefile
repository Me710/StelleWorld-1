# Makefile pour StelleWorld Backend
.PHONY: help install test test-unit test-integration lint format clean dev init-db

# Variables
PYTHON := python
PIP := pip
PYTEST := pytest
BLACK := black
ISORT := isort
FLAKE8 := flake8

help: ## Afficher l'aide
	@echo "Commandes disponibles pour StelleWorld Backend :"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

install: ## Installer les dÃ©pendances
	$(PIP) install -r requirements.txt
	@echo "âœ… DÃ©pendances installÃ©es"

test: ## Lancer tous les tests
	$(PYTEST) -v
	@echo "âœ… Tests terminÃ©s"

test-unit: ## Lancer les tests unitaires uniquement
	$(PYTEST) -v -m "not integration"
	@echo "âœ… Tests unitaires terminÃ©s"

test-integration: ## Lancer les tests d'intÃ©gration
	$(PYTEST) -v -m "integration"
	@echo "âœ… Tests d'intÃ©gration terminÃ©s"

test-admin: ## Lancer les tests d'administration
	$(PYTEST) -v -m "admin"
	@echo "âœ… Tests admin terminÃ©s"

test-auth: ## Lancer les tests d'authentification
	$(PYTEST) -v -m "auth"
	@echo "âœ… Tests d'authentification terminÃ©s"

test-coverage: ## Lancer les tests avec couverture dÃ©taillÃ©e
	$(PYTEST) --cov=app --cov-report=html --cov-report=term-missing
	@echo "âœ… Tests avec couverture terminÃ©s"
	@echo "ğŸ“Š Rapport HTML disponible dans htmlcov/"

lint: ## VÃ©rifier la qualitÃ© du code
	@echo "ğŸ” VÃ©rification avec flake8..."
	$(FLAKE8) app/
	@echo "ğŸ” VÃ©rification des imports avec isort..."
	$(ISORT) --check-only app/
	@echo "ğŸ” VÃ©rification du formatage avec black..."
	$(BLACK) --check app/
	@echo "âœ… QualitÃ© du code vÃ©rifiÃ©e"

format: ## Formater le code automatiquement
	@echo "ğŸ¨ Formatage avec black..."
	$(BLACK) app/
	@echo "ğŸ¨ Organisation des imports avec isort..."
	$(ISORT) app/
	@echo "âœ… Code formatÃ©"

clean: ## Nettoyer les fichiers temporaires
	@echo "ğŸ§¹ Nettoyage..."
	find . -type d -name __pycache__ -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name "*.pyd" -delete
	find . -type f -name ".coverage" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	find . -type d -name "htmlcov" -exec rm -rf {} +
	@echo "âœ… Nettoyage terminÃ©"

dev: ## Lancer le serveur de dÃ©veloppement
	$(PYTHON) run.py
	@echo "ğŸš€ Serveur de dÃ©veloppement dÃ©marrÃ©"

init-db: ## Initialiser la base de donnÃ©es
	$(PYTHON) init_stelleworld_db.py
	@echo "âœ… Base de donnÃ©es initialisÃ©e"

check: lint test ## VÃ©rifier la qualitÃ© et lancer les tests
	@echo "âœ… VÃ©rifications complÃ¨tes terminÃ©es"

ci: install lint test ## Pipeline CI/CD
	@echo "âœ… Pipeline CI/CD terminÃ©"

# Commandes spÃ©cifiques au dÃ©veloppement
migrate: ## CrÃ©er et appliquer les migrations
	@echo "ğŸ“¦ CrÃ©ation des migrations..."
	# alembic revision --autogenerate -m "Auto migration"
	# alembic upgrade head
	@echo "âœ… Migrations appliquÃ©es"

seed: init-db ## Alimenter la base avec des donnÃ©es de test
	@echo "ğŸŒ± Base alimentÃ©e avec des donnÃ©es de test"

reset-db: ## RÃ©initialiser complÃ¨tement la base de donnÃ©es
	@echo "âš ï¸  RÃ©initialisation de la base de donnÃ©es..."
	rm -f stelleworld.db
	$(MAKE) init-db
	@echo "âœ… Base de donnÃ©es rÃ©initialisÃ©e"

# Commandes de production
prod-test: ## Tests pour la production
	$(PYTEST) --cov=app --cov-fail-under=90
	@echo "âœ… Tests de production validÃ©s"

# Debug et dÃ©veloppement
debug: ## Lancer en mode debug
	DEBUG=1 $(PYTHON) run.py
	@echo "ğŸ› Mode debug activÃ©"

shell: ## Ouvrir un shell Python avec le contexte de l'app
	$(PYTHON) -c "from app.main import app; from app.core.database import SessionLocal; db = SessionLocal(); print('Shell StelleWorld - Variables: app, db')"

# Affichage par dÃ©faut
default: help
