# Makefile for local development (without Docker)
# StelleWorld Local Development Commands

.PHONY: help setup dev worker beat test lint format migrate clean install-deps

# Variables
PYTHON = python
PIP = pip
UVICORN = uvicorn
ALEMBIC = alembic
PYTEST = pytest
BLACK = black
ISORT = isort
FLAKE8 = flake8
CELERY = celery

# Default target
help: ## Show this help message
	@echo "StelleWorld Local Development Commands"
	@echo "====================================="
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

setup: ## Initial setup - create venv and install dependencies
	@echo "üöÄ Setting up StelleWorld development environment..."
	@echo "üì¶ Creating virtual environment..."
	$(PYTHON) -m venv venv
	@echo "üîß Activating virtual environment..."
	@echo "   Run: source venv/bin/activate (Linux/macOS) or venv\\Scripts\\activate (Windows)"
	@echo "üìö Installing dependencies..."
	$(PIP) install --upgrade pip
	$(PIP) install -r requirements.txt
	@echo "‚úÖ Setup complete! Don't forget to:"
	@echo "   1. Activate your virtual environment"
	@echo "   2. Install PostgreSQL and Redis"
	@echo "   3. Create a .env file"
	@echo "   4. Set up your database"

install-deps: ## Install Python dependencies (requires activated venv)
	@echo "üìö Installing Python dependencies..."
	$(PIP) install --upgrade pip
	$(PIP) install -r requirements.txt
	@echo "‚úÖ Dependencies installed!"

dev: ## Start the FastAPI development server
	@echo "üöÄ Starting StelleWorld development server..."
	$(UVICORN) app.main:app --reload --host 0.0.0.0 --port 8000

worker: ## Start Celery worker
	@echo "üë∑ Starting Celery worker..."
	$(CELERY) -A worker.celery_app worker --loglevel=info

beat: ## Start Celery beat scheduler
	@echo "‚è∞ Starting Celery beat scheduler..."
	$(CELERY) -A worker.celery_app beat --loglevel=info

test: ## Run tests
	@echo "üß™ Running tests..."
	$(PYTEST)

test-cov: ## Run tests with coverage report
	@echo "üß™ Running tests with coverage..."
	$(PYTEST) --cov=app --cov-report=html

lint: ## Check code quality
	@echo "üîç Checking code quality..."
	$(FLAKE8) app/
	$(BLACK) --check app/
	$(ISORT) --check-only app/

format: ## Format code automatically
	@echo "‚ú® Formatting code..."
	$(BLACK) app/
	$(ISORT) app/

migrate: ## Apply database migrations
	@echo "üóÑÔ∏è Applying database migrations..."
	$(ALEMBIC) upgrade head

migrate-create: ## Create a new migration
	@read -p "Migration name: " name; \
	$(ALEMBIC) revision --autogenerate -m "$$name"

migrate-rollback: ## Rollback last migration
	@echo "‚Ü©Ô∏è Rolling back last migration..."
	$(ALEMBIC) downgrade -1

migrate-history: ## Show migration history
	@echo "üìú Migration history:"
	$(ALEMBIC) history

db-init: ## Initialize database (first time setup)
	@echo "üóÑÔ∏è Initializing database..."
	$(ALEMBIC) init alembic
	@echo "üìù Creating initial migration..."
	$(ALEMBIC) revision --autogenerate -m "Initial migration"
	@echo "üöÄ Applying migrations..."
	$(ALEMBIC) upgrade head

clean: ## Clean up temporary files
	@echo "üßπ Cleaning up..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	rm -rf .pytest_cache/
	rm -rf htmlcov/
	rm -rf .coverage
	@echo "‚úÖ Cleanup complete!"

venv-clean: ## Remove virtual environment
	@echo "üóëÔ∏è Removing virtual environment..."
	rm -rf venv/
	@echo "‚úÖ Virtual environment removed!"

full-clean: clean venv-clean ## Complete cleanup (venv + temp files)
	@echo "üßπ Complete cleanup finished!"

check-deps: ## Check if required services are running
	@echo "üîç Checking required services..."
	@echo "Checking PostgreSQL..."
	@pg_isready -h localhost -p 5432 > /dev/null 2>&1 && echo "‚úÖ PostgreSQL: Running" || echo "‚ùå PostgreSQL: Not running"
	@echo "Checking Redis..."
	@redis-cli ping > /dev/null 2>&1 && echo "‚úÖ Redis: Running" || echo "‚ùå Redis: Not running"

install-postgres: ## Install PostgreSQL (Ubuntu/Debian)
	@echo "üóÑÔ∏è Installing PostgreSQL..."
	sudo apt update
	sudo apt install postgresql postgresql-contrib
	@echo "‚úÖ PostgreSQL installed!"
	@echo "   Start with: sudo systemctl start postgresql"

install-redis: ## Install Redis (Ubuntu/Debian)
	@echo "üî¥ Installing Redis..."
	sudo apt update
	sudo apt install redis-server
	@echo "‚úÖ Redis installed!"
	@echo "   Start with: sudo systemctl start redis-server"

start-services: ## Start PostgreSQL and Redis services
	@echo "üöÄ Starting services..."
	sudo systemctl start postgresql
	sudo systemctl start redis-server
	@echo "‚úÖ Services started!"

stop-services: ## Stop PostgreSQL and Redis services
	@echo "üõë Stopping services..."
	sudo systemctl stop postgresql
	sudo systemctl stop redis-server
	@echo "‚úÖ Services stopped!"

status: ## Show status of services
	@echo "üìä Service Status:"
	@echo "PostgreSQL:"
	sudo systemctl status postgresql --no-pager -l
	@echo "Redis:"
	sudo systemctl status redis-server --no-pager -l

# Development workflow shortcuts
dev-full: worker beat ## Start all development services (API + worker + beat)
	@echo "üöÄ Starting all development services..."
	@echo "   API: http://localhost:8000"
	@echo "   Worker: Running in background"
	@echo "   Beat: Running in background"

# Quick development commands
quick-test: ## Quick test run
	$(PYTEST) -x -v

quick-lint: ## Quick lint check
	$(FLAKE8) app/ --max-line-length=88 --ignore=E203,W503

quick-format: ## Quick format check
	$(BLACK) --check app/
	$(ISORT) --check-only app/

# Database management
db-reset: ## Reset database (drop and recreate)
	@echo "‚ö†Ô∏è  WARNING: This will delete all data!"
	@read -p "Are you sure? Type 'yes' to continue: " confirm; \
	if [ "$$confirm" = "yes" ]; then \
		echo "üóëÔ∏è Dropping database..."; \
		dropdb stelleworld; \
		echo "üÜï Creating database..."; \
		createdb stelleworld; \
		echo "üöÄ Running migrations..."; \
		$(ALEMBIC) upgrade head; \
		echo "‚úÖ Database reset complete!"; \
	else \
		echo "‚ùå Database reset cancelled"; \
	fi

# Environment setup
env-create: ## Create .env file from template
	@if [ ! -f .env ]; then \
		echo "üìù Creating .env file..."; \
		cp .env_example .env 2>/dev/null || echo "# StelleWorld Environment Variables" > .env; \
		echo "‚úÖ .env file created!"; \
		echo "   Please edit it with your configuration"; \
	else \
		echo "‚ÑπÔ∏è  .env file already exists"; \
	fi

# Help for common issues
troubleshoot: ## Show common troubleshooting tips
	@echo "üîß Common Troubleshooting Tips:"
	@echo ""
	@echo "1. Database connection issues:"
	@echo "   - Check if PostgreSQL is running: sudo systemctl status postgresql"
	@echo "   - Verify connection: psql -U stelleworld -d stelleworld"
	@echo ""
	@echo "2. Redis connection issues:"
	@echo "   - Check if Redis is running: redis-cli ping"
	@echo "   - Start Redis: sudo systemctl start redis-server"
	@echo ""
	@echo "3. Virtual environment issues:"
	@echo "   - Activate venv: source venv/bin/activate"
	@echo "   - Reinstall deps: make install-deps"
	@echo ""
	@echo "4. Port conflicts:"
	@echo "   - Check what's using port 8000: lsof -i :8000"
	@echo "   - Use different port: uvicorn app.main:app --port 8001"
