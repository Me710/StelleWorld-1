{% extends "admin/base.html" %}

{% block title %}Statistiques de Vente{% endblock %}
{% block page_title %}Statistiques de Vente{% endblock %}

{% block extra_head %}
<style>
    .chart-container {
        position: relative;
        height: 400px;
    }
    .stat-card {
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
    }
    .period-selector .active {
        background-color: #4f46e5;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="salesStats()" x-init="init()" class="space-y-6">
    
    <!-- Sélecteur de période -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div>
                <h2 class="text-lg font-semibold text-gray-900">Période d'analyse</h2>
                <p class="text-sm text-gray-500">Sélectionnez la période pour les statistiques</p>
            </div>
            
            <div class="flex space-x-1 period-selector">
                <button @click="changePeriod('week')" 
                        :class="currentPeriod === 'week' ? 'active' : ''" 
                        class="px-3 py-2 text-sm font-medium rounded-md border border-gray-300 hover:bg-gray-50">
                    7 jours
                </button>
                <button @click="changePeriod('month')" 
                        :class="currentPeriod === 'month' ? 'active' : ''" 
                        class="px-3 py-2 text-sm font-medium rounded-md border border-gray-300 hover:bg-gray-50">
                    30 jours
                </button>
                <button @click="changePeriod('quarter')" 
                        :class="currentPeriod === 'quarter' ? 'active' : ''" 
                        class="px-3 py-2 text-sm font-medium rounded-md border border-gray-300 hover:bg-gray-50">
                    3 mois
                </button>
                <button @click="changePeriod('year')" 
                        :class="currentPeriod === 'year' ? 'active' : ''" 
                        class="px-3 py-2 text-sm font-medium rounded-md border border-gray-300 hover:bg-gray-50">
                    1 an
                </button>
            </div>
        </div>
    </div>

    <!-- KPIs principaux -->
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
        <!-- Chiffre d'affaires -->
        <div class="stat-card bg-white overflow-hidden shadow rounded-lg border-l-4 border-l-green-400">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Chiffre d'Affaires</dt>
                            <dd x-text="formatCurrency(stats.total_revenue)" class="text-lg font-medium text-green-600">0 €</dd>
                            <dd class="text-sm" :class="stats.revenue_growth >= 0 ? 'text-green-600' : 'text-red-600'">
                                <span x-text="(stats.revenue_growth >= 0 ? '+' : '') + stats.revenue_growth + '%'"></span>
                                <span class="text-gray-500">vs période précédente</span>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Commandes -->
        <div class="stat-card bg-white overflow-hidden shadow rounded-lg border-l-4 border-l-blue-400">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Commandes</dt>
                            <dd x-text="stats.total_orders" class="text-lg font-medium text-blue-600">0</dd>
                            <dd class="text-sm" :class="stats.orders_growth >= 0 ? 'text-green-600' : 'text-red-600'">
                                <span x-text="(stats.orders_growth >= 0 ? '+' : '') + stats.orders_growth + '%'"></span>
                                <span class="text-gray-500">vs période précédente</span>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panier moyen -->
        <div class="stat-card bg-white overflow-hidden shadow rounded-lg border-l-4 border-l-purple-400">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m2.6 8L6 5H3M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17M17 13v4a2 2 0 01-2 2H9a2 2 0 01-2-2v-4m8 0V9a2 2 0 00-2-2H9a2 2 0 00-2 2v4.01"/>
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Panier Moyen</dt>
                            <dd x-text="formatCurrency(stats.average_order_value)" class="text-lg font-medium text-purple-600">0 €</dd>
                            <dd class="text-sm" :class="stats.aov_growth >= 0 ? 'text-green-600' : 'text-red-600'">
                                <span x-text="(stats.aov_growth >= 0 ? '+' : '') + stats.aov_growth + '%'"></span>
                                <span class="text-gray-500">vs période précédente</span>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nouveaux clients -->
        <div class="stat-card bg-white overflow-hidden shadow rounded-lg border-l-4 border-l-orange-400">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Nouveaux Clients</dt>
                            <dd x-text="stats.new_customers" class="text-lg font-medium text-orange-600">0</dd>
                            <dd class="text-sm" :class="stats.customers_growth >= 0 ? 'text-green-600' : 'text-red-600'">
                                <span x-text="(stats.customers_growth >= 0 ? '+' : '') + stats.customers_growth + '%'"></span>
                                <span class="text-gray-500">vs période précédente</span>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphique principal - Évolution du CA -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900">Évolution du Chiffre d'Affaires</h3>
            <div class="flex space-x-2">
                <select x-model="chartType" @change="updateChart()" class="block w-32 px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    <option value="line">Courbe</option>
                    <option value="bar">Barres</option>
                    <option value="area">Aires</option>
                </select>
            </div>
        </div>
        
        <div class="chart-container">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Top produits -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Produits les Plus Vendus</h3>
            
            <div class="space-y-4">
                <template x-for="(product, index) in topProducts" :key="product.product_id">
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center">
                                <span class="text-sm font-medium text-indigo-600" x-text="index + 1"></span>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900" x-text="product.product_name"></p>
                            <p class="text-sm text-gray-500">
                                <span x-text="product.total_sold"></span> vendus - 
                                <span x-text="formatCurrency(product.total_revenue)"></span>
                            </p>
                        </div>
                        <div class="flex-shrink-0">
                            <div class="w-20 bg-gray-200 rounded-full h-2">
                                <div class="bg-indigo-600 h-2 rounded-full" 
                                     :style="`width: ${(product.total_revenue / topProducts[0]?.total_revenue) * 100}%`"></div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Répartition par catégorie -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Ventes par Catégorie</h3>
            
            <div class="chart-container h-64">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Commandes par statut -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Commandes par Statut</h3>
            
            <div class="space-y-3">
                <template x-for="status in orderStatuses" :key="status.name">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full mr-3" :class="status.color"></div>
                            <span class="text-sm font-medium text-gray-900" x-text="status.label"></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-500" x-text="status.count"></span>
                            <div class="w-16 bg-gray-200 rounded-full h-1">
                                <div class="h-1 rounded-full" 
                                     :class="status.color.replace('bg-', 'bg-')"
                                     :style="`width: ${(status.count / stats.total_orders) * 100}%`"></div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Moyens de paiement -->
        <div class="bg-white shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Moyens de Paiement</h3>
            
            <div class="chart-container h-64">
                <canvas id="paymentChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Tableau détaillé -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Détail des Ventes par Jour</h3>
                <button @click="exportSalesData()" 
                        class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Exporter
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Commandes</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Chiffre d'Affaires</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Panier Moyen</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Conversion</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="day in dailyStats" :key="day.date">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" 
                                    x-text="formatDate(day.date)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right" 
                                    x-text="day.orders"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right" 
                                    x-text="formatCurrency(day.revenue)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right" 
                                    x-text="formatCurrency(day.avg_order_value)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                                    <span x-text="day.conversion_rate + '%'" 
                                          :class="day.conversion_rate >= 2 ? 'text-green-600' : day.conversion_rate >= 1 ? 'text-yellow-600' : 'text-red-600'"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function salesStats() {
        return {
            currentPeriod: 'month',
            chartType: 'line',
            stats: {
                total_revenue: 0,
                total_orders: 0,
                average_order_value: 0,
                new_customers: 0,
                revenue_growth: 0,
                orders_growth: 0,
                aov_growth: 0,
                customers_growth: 0
            },
            topProducts: [],
            orderStatuses: [],
            dailyStats: [],
            categoryData: [],
            paymentData: [],
            
            // Charts
            revenueChart: null,
            categoryChart: null,
            paymentChart: null,
            
            async init() {
                await this.loadSalesData();
            },
            
            async changePeriod(period) {
                this.currentPeriod = period;
                await this.loadSalesData();
            },
            
            async loadSalesData() {
                try {
                    // Charger les statistiques principales
                    const revenueData = await apiCall(`/admin/stats/revenue?period=${this.currentPeriod}`);
                    this.stats = {
                        total_revenue: revenueData.total_revenue,
                        revenue_growth: revenueData.growth_rate,
                        ...this.stats
                    };
                    
                    // Charger les données du dashboard pour les autres stats
                    const overviewData = await apiCall('/analytics/sales-overview?period_days=' + this.getPeriodDays());
                    this.stats = {
                        ...this.stats,
                        total_orders: overviewData.summary.total_orders,
                        average_order_value: overviewData.summary.average_order_value,
                        new_customers: overviewData.summary.new_customers
                    };
                    
                    // Charger les produits les plus vendus
                    const bestSellersData = await apiCall(`/analytics/best-sellers?period_days=${this.getPeriodDays()}&limit=5`);
                    this.topProducts = bestSellersData.best_sellers;
                    
                    // Générer des données simulées pour les autres graphiques
                    this.generateMockData();
                    
                    // Mettre à jour les graphiques
                    await this.$nextTick();
                    this.renderCharts();
                    
                } catch (error) {
                    console.error('Erreur lors du chargement des données:', error);
                }
            },
            
            generateMockData() {
                // Statuts de commandes
                this.orderStatuses = [
                    { name: 'confirmed', label: 'Confirmées', count: Math.floor(this.stats.total_orders * 0.4), color: 'bg-green-500' },
                    { name: 'processing', label: 'En traitement', count: Math.floor(this.stats.total_orders * 0.25), color: 'bg-blue-500' },
                    { name: 'shipped', label: 'Expédiées', count: Math.floor(this.stats.total_orders * 0.2), color: 'bg-yellow-500' },
                    { name: 'delivered', label: 'Livrées', count: Math.floor(this.stats.total_orders * 0.1), color: 'bg-purple-500' },
                    { name: 'cancelled', label: 'Annulées', count: Math.floor(this.stats.total_orders * 0.05), color: 'bg-red-500' }
                ];
                
                // Données par catégorie
                this.categoryData = [
                    { name: 'Électronique', value: 35, revenue: this.stats.total_revenue * 0.35 },
                    { name: 'Vêtements', value: 25, revenue: this.stats.total_revenue * 0.25 },
                    { name: 'Maison', value: 20, revenue: this.stats.total_revenue * 0.20 },
                    { name: 'Sport', value: 15, revenue: this.stats.total_revenue * 0.15 },
                    { name: 'Autres', value: 5, revenue: this.stats.total_revenue * 0.05 }
                ];
                
                // Moyens de paiement
                this.paymentData = [
                    { name: 'Carte bancaire', value: 70 },
                    { name: 'PayPal', value: 20 },
                    { name: 'Virement', value: 8 },
                    { name: 'Autres', value: 2 }
                ];
                
                // Statistiques quotidiennes
                this.dailyStats = [];
                const days = this.getPeriodDays();
                for (let i = days - 1; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    
                    const dailyOrders = Math.floor(Math.random() * 50) + 10;
                    const dailyRevenue = dailyOrders * (Math.random() * 100 + 50);
                    
                    this.dailyStats.push({
                        date: date.toISOString().split('T')[0],
                        orders: dailyOrders,
                        revenue: dailyRevenue,
                        avg_order_value: dailyRevenue / dailyOrders,
                        conversion_rate: (Math.random() * 3 + 0.5).toFixed(1)
                    });
                }
            },
            
            getPeriodDays() {
                switch (this.currentPeriod) {
                    case 'week': return 7;
                    case 'month': return 30;
                    case 'quarter': return 90;
                    case 'year': return 365;
                    default: return 30;
                }
            },
            
            renderCharts() {
                this.renderRevenueChart();
                this.renderCategoryChart();
                this.renderPaymentChart();
            },
            
            renderRevenueChart() {
                const ctx = document.getElementById('revenueChart');
                if (!ctx) return;
                
                if (this.revenueChart) {
                    this.revenueChart.destroy();
                }
                
                const chartConfig = {
                    type: this.chartType === 'area' ? 'line' : this.chartType,
                    data: {
                        labels: this.dailyStats.map(item => this.formatDate(item.date)),
                        datasets: [{
                            label: 'Chiffre d\'affaires (€)',
                            data: this.dailyStats.map(item => item.revenue),
                            borderColor: 'rgb(79, 70, 229)',
                            backgroundColor: this.chartType === 'area' ? 'rgba(79, 70, 229, 0.1)' : 'rgba(79, 70, 229, 0.8)',
                            fill: this.chartType === 'area',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString('fr-FR') + ' €';
                                    }
                                }
                            }
                        }
                    }
                };
                
                this.revenueChart = new Chart(ctx, chartConfig);
            },
            
            renderCategoryChart() {
                const ctx = document.getElementById('categoryChart');
                if (!ctx) return;
                
                if (this.categoryChart) {
                    this.categoryChart.destroy();
                }
                
                this.categoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: this.categoryData.map(item => item.name),
                        datasets: [{
                            data: this.categoryData.map(item => item.value),
                            backgroundColor: [
                                '#4f46e5',
                                '#06b6d4',
                                '#10b981',
                                '#f59e0b',
                                '#ef4444'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            },
            
            renderPaymentChart() {
                const ctx = document.getElementById('paymentChart');
                if (!ctx) return;
                
                if (this.paymentChart) {
                    this.paymentChart.destroy();
                }
                
                this.paymentChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: this.paymentData.map(item => item.name),
                        datasets: [{
                            data: this.paymentData.map(item => item.value),
                            backgroundColor: [
                                '#8b5cf6',
                                '#f59e0b',
                                '#10b981',
                                '#6b7280'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            },
            
            updateChart() {
                this.renderRevenueChart();
            },
            
            formatCurrency(amount) {
                return new Intl.NumberFormat('fr-FR', {
                    style: 'currency',
                    currency: 'EUR'
                }).format(amount);
            },
            
            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('fr-FR', { 
                    month: 'short', 
                    day: 'numeric' 
                });
            },
            
            async exportSalesData() {
                try {
                    const csvData = this.generateCSVData();
                    this.downloadCSV(csvData, `sales-stats-${this.currentPeriod}-${new Date().toISOString().split('T')[0]}.csv`);
                } catch (error) {
                    console.error('Erreur lors de l\'export:', error);
                }
            },
            
            generateCSVData() {
                let csv = 'Date,Commandes,Chiffre d\'Affaires,Panier Moyen,Taux de Conversion\n';
                
                this.dailyStats.forEach(day => {
                    csv += `${day.date},${day.orders},${day.revenue.toFixed(2)},${day.avg_order_value.toFixed(2)},${day.conversion_rate}\n`;
                });
                
                return csv;
            },
            
            downloadCSV(csvData, filename) {
                const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    }
</script>
{% endblock %}
