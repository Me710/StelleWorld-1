{% extends "admin/base.html" %}

{% block title %}{% if product %}Modifier{% else %}Créer{% endif %} un Produit{% endblock %}
{% block page_title %}{% if product %}Modifier{% else %}Créer{% endif %} un Produit{% endblock %}

{% block extra_head %}
<style>
    .drag-drop-zone {
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    .drag-drop-zone.dragover {
        border-color: #6366f1;
        background-color: #eff6ff;
    }
    .image-preview {
        position: relative;
        display: inline-block;
        margin-right: 1rem;
        margin-bottom: 1rem;
    }
    .image-preview img {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
    }
    .image-preview .remove-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="productForm()" x-init="init()" class="max-w-4xl mx-auto">
    
    <!-- Navigation -->
    <nav class="flex mb-6" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-4">
            <li>
                <a href="/admin/products" class="text-gray-400 hover:text-gray-600">Produits</a>
            </li>
            <li>
                <svg class="flex-shrink-0 h-4 w-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 111.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                </svg>
                <span class="text-gray-500">{% if product %}Modifier{% else %}Nouveau produit{% endif %}</span>
            </li>
        </ol>
    </nav>

    <form @submit.prevent="saveProduct()" class="space-y-8 bg-white shadow rounded-lg p-6">
        
        <!-- Informations de base -->
        <div class="space-y-6">
            <div>
                <h3 class="text-lg font-medium text-gray-900">Informations de base</h3>
                <p class="mt-1 text-sm text-gray-500">Renseignez les informations principales du produit</p>
            </div>
            
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div class="col-span-2">
                    <label for="name" class="block text-sm font-medium text-gray-700">Nom du produit *</label>
                    <input x-model="form.name" 
                           type="text" 
                           id="name" 
                           required
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div class="col-span-2">
                    <label for="short_description" class="block text-sm font-medium text-gray-700">Description courte</label>
                    <textarea x-model="form.short_description" 
                              id="short_description" 
                              rows="2"
                              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                
                <div class="col-span-2">
                    <label for="description" class="block text-sm font-medium text-gray-700">Description détaillée</label>
                    <textarea x-model="form.description" 
                              id="description" 
                              rows="6"
                              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                
                <div>
                    <label for="category_id" class="block text-sm font-medium text-gray-700">Catégorie</label>
                    <select x-model="form.category_id" 
                            id="category_id"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Sélectionner une catégorie</option>
                        <template x-for="category in categories" :key="category.id">
                            <option :value="category.id" x-text="category.name"></option>
                        </template>
                    </select>
                </div>
                
                <div>
                    <label for="product_type" class="block text-sm font-medium text-gray-700">Type de produit</label>
                    <select x-model="form.product_type" 
                            id="product_type"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="physical">Physique</option>
                        <option value="digital">Numérique</option>
                        <option value="service">Service</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Images -->
        <div class="space-y-6">
            <div>
                <h3 class="text-lg font-medium text-gray-900">Images</h3>
                <p class="mt-1 text-sm text-gray-500">Ajoutez des images pour votre produit</p>
            </div>
            
            <!-- Zone de drop pour images -->
            <div class="drag-drop-zone p-6 text-center cursor-pointer" 
                 @dragover.prevent="dragover = true"
                 @dragleave.prevent="dragover = false"
                 @drop.prevent="handleDrop($event)"
                 @click="$refs.imageInput.click()"
                 :class="{ 'dragover': dragover }">
                 
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <p class="mt-2 text-sm text-gray-600">
                    <span class="font-medium">Cliquez pour télécharger</span> ou glissez-déposez
                </p>
                <p class="text-xs text-gray-500">PNG, JPG, GIF jusqu'à 5MB</p>
            </div>
            
            <input x-ref="imageInput" 
                   @change="handleFiles($event.target.files)"
                   type="file" 
                   multiple 
                   accept="image/*" 
                   class="hidden">

            <!-- Aperçu des images -->
            <div x-show="images.length > 0" class="mt-4">
                <h4 class="text-sm font-medium text-gray-900 mb-2">Images sélectionnées</h4>
                <div class="flex flex-wrap">
                    <template x-for="(image, index) in images" :key="index">
                        <div class="image-preview">
                            <img :src="image.url" :alt="'Image ' + (index + 1)">
                            <button @click.stop="removeImage(index)" 
                                    type="button" 
                                    class="remove-btn">
                                ×
                            </button>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Prix et stock -->
        <div class="space-y-6">
            <div>
                <h3 class="text-lg font-medium text-gray-900">Prix et inventaire</h3>
                <p class="mt-1 text-sm text-gray-500">Définissez les prix et gérez le stock</p>
            </div>
            
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-3">
                <div>
                    <label for="price" class="block text-sm font-medium text-gray-700">Prix de vente (€) *</label>
                    <input x-model.number="form.price" 
                           type="number" 
                           step="0.01" 
                           min="0" 
                           id="price" 
                           required
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div>
                    <label for="compare_at_price" class="block text-sm font-medium text-gray-700">Prix barré (€)</label>
                    <input x-model.number="form.compare_at_price" 
                           type="number" 
                           step="0.01" 
                           min="0" 
                           id="compare_at_price"
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div>
                    <label for="cost_price" class="block text-sm font-medium text-gray-700">Prix de revient (€)</label>
                    <input x-model.number="form.cost_price" 
                           type="number" 
                           step="0.01" 
                           min="0" 
                           id="cost_price"
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                    <label class="flex items-center">
                        <input x-model="form.track_inventory" type="checkbox" class="form-checkbox">
                        <span class="ml-2 text-sm text-gray-700">Suivre l'inventaire</span>
                    </label>
                </div>
                
                <div x-show="form.track_inventory">
                    <label for="stock_quantity" class="block text-sm font-medium text-gray-700">Quantité en stock</label>
                    <input x-model.number="form.stock_quantity" 
                           type="number" 
                           min="0" 
                           id="stock_quantity"
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            
            <div x-show="form.track_inventory">
                <label class="flex items-center">
                    <input x-model="form.allow_backorder" type="checkbox" class="form-checkbox">
                    <span class="ml-2 text-sm text-gray-700">Autoriser les commandes même si rupture de stock</span>
                </label>
            </div>
        </div>

        <!-- SEO et métadonnées -->
        <div class="space-y-6">
            <div>
                <h3 class="text-lg font-medium text-gray-900">SEO et métadonnées</h3>
                <p class="mt-1 text-sm text-gray-500">Optimisez le référencement de votre produit</p>
            </div>
            
            <div class="grid grid-cols-1 gap-6">
                <div>
                    <label for="meta_title" class="block text-sm font-medium text-gray-700">Titre SEO</label>
                    <input x-model="form.meta_title" 
                           type="text" 
                           id="meta_title"
                           maxlength="60"
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <p class="mt-1 text-sm text-gray-500">Recommandé : 50-60 caractères</p>
                </div>
                
                <div>
                    <label for="meta_description" class="block text-sm font-medium text-gray-700">Description SEO</label>
                    <textarea x-model="form.meta_description" 
                              id="meta_description" 
                              rows="3"
                              maxlength="160"
                              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    <p class="mt-1 text-sm text-gray-500">Recommandé : 150-160 caractères</p>
                </div>
            </div>
        </div>

        <!-- Paramètres -->
        <div class="space-y-6">
            <div>
                <h3 class="text-lg font-medium text-gray-900">Paramètres</h3>
                <p class="mt-1 text-sm text-gray-500">Options de visibilité et de configuration</p>
            </div>
            
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                    <label class="flex items-center">
                        <input x-model="form.is_active" type="checkbox" class="form-checkbox">
                        <span class="ml-2 text-sm text-gray-700">Produit actif (visible sur le site)</span>
                    </label>
                </div>
                
                <div>
                    <label class="flex items-center">
                        <input x-model="form.is_featured" type="checkbox" class="form-checkbox">
                        <span class="ml-2 text-sm text-gray-700">Produit vedette</span>
                    </label>
                </div>
                
                <div>
                    <label class="flex items-center">
                        <input x-model="form.is_subscription" type="checkbox" class="form-checkbox">
                        <span class="ml-2 text-sm text-gray-700">Produit d'abonnement</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
            <a href="/admin/products" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                Annuler
            </a>
            <button type="submit" 
                    :disabled="saving"
                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50">
                <span x-show="!saving">{% if product %}Mettre à jour{% else %}Créer{% endif %} le produit</span>
                <span x-show="saving">Enregistrement...</span>
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function productForm() {
        return {
            form: {
                name: '',
                description: '',
                short_description: '',
                price: 0,
                compare_at_price: null,
                cost_price: null,
                stock_quantity: 0,
                track_inventory: true,
                allow_backorder: false,
                product_type: 'physical',
                is_subscription: false,
                category_id: '',
                is_active: true,
                is_featured: false,
                meta_title: '',
                meta_description: ''
            },
            categories: [],
            images: [],
            dragover: false,
            saving: false,
            productId: null,
            
            async init() {
                await this.loadCategories();
                
                // Si nous modifions un produit, charger ses données
                const urlParams = new URLSearchParams(window.location.search);
                const productId = window.location.pathname.match(/\/admin\/products\/(\d+)\/edit/);
                if (productId) {
                    this.productId = productId[1];
                    await this.loadProduct(this.productId);
                }
            },
            
            async loadCategories() {
                try {
                    const data = await apiCall('/admin/categories');
                    this.categories = data.categories;
                } catch (error) {
                    console.error('Erreur lors du chargement des catégories:', error);
                }
            },
            
            async loadProduct(id) {
                try {
                    const product = await apiCall(`/admin/products/${id}`);
                    
                    // Remplir le formulaire avec les données du produit
                    Object.keys(this.form).forEach(key => {
                        if (product.hasOwnProperty(key)) {
                            this.form[key] = product[key];
                        }
                    });
                    
                    // Charger les images existantes
                    if (product.main_image_url) {
                        this.images.push({
                            url: product.main_image_url,
                            uploaded: true
                        });
                    }
                } catch (error) {
                    console.error('Erreur lors du chargement du produit:', error);
                    alert('Impossible de charger le produit');
                }
            },
            
            handleFiles(files) {
                Array.from(files).forEach(file => {
                    if (file.type.startsWith('image/')) {
                        this.uploadImage(file);
                    }
                });
            },
            
            handleDrop(e) {
                this.dragover = false;
                this.handleFiles(e.dataTransfer.files);
            },
            
            async uploadImage(file) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const response = await fetch('/api/admin/upload/product-image', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                        },
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error('Upload failed');
                    }
                    
                    const result = await response.json();
                    
                    this.images.push({
                        url: result.url,
                        filename: result.filename,
                        uploaded: true
                    });
                } catch (error) {
                    console.error('Erreur lors de l\'upload:', error);
                    alert('Erreur lors du téléchargement de l\'image');
                }
            },
            
            removeImage(index) {
                this.images.splice(index, 1);
            },
            
            async saveProduct() {
                if (this.saving) return;
                
                this.saving = true;
                
                try {
                    // Préparer les données du formulaire
                    const formData = new FormData();
                    
                    Object.entries(this.form).forEach(([key, value]) => {
                        if (value !== null && value !== '') {
                            formData.append(key, value);
                        }
                    });
                    
                    // Ajouter l'image principale si présente
                    if (this.images.length > 0) {
                        formData.append('main_image_url', this.images[0].url);
                    }
                    
                    const url = this.productId 
                        ? `/admin/products/${this.productId}`
                        : '/admin/products';
                    
                    const method = this.productId ? 'PUT' : 'POST';
                    
                    const response = await fetch(`/api${url}`, {
                        method: method,
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                        },
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error('Save failed');
                    }
                    
                    const result = await response.json();
                    
                    // Rediriger vers la liste des produits
                    window.location.href = '/admin/products';
                    
                } catch (error) {
                    console.error('Erreur lors de la sauvegarde:', error);
                    alert('Erreur lors de la sauvegarde du produit');
                } finally {
                    this.saving = false;
                }
            }
        }
    }
</script>
{% endblock %}
