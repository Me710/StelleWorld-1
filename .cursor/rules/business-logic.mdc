---
globs: backend/app/services/*.py,backend/app/api/*.py
description: R√®gles pour la logique m√©tier sp√©cifique √† StelleWorld
---

# Logique M√©tier StelleWorld

## Domaines fonctionnels

### üõçÔ∏è E-commerce & Catalogue
- **Produits** : Gestion du stock, variations (taille, couleur), cat√©gories
- **Panier** : Persistance locale et serveur, calculs de prix
- **Commandes** : Workflow complet avec statuts (en attente, pay√©e, exp√©di√©e, livr√©e)
- **Inventaire** : R√©servation temporaire lors de l'ajout au panier

### üí≥ Paiements & Abonnements
- **Stripe Integration** : Paiements uniques et r√©currents
- **Webhooks** : Synchronisation automatique des statuts Stripe
- **Abonnements** : Formules mensuelles/annuelles avec gestion du cycle de vie
- **Refunds** : Remboursements partiels ou complets

### üìÖ Services & Rendez-vous
- **Cr√©neaux** : Disponibilit√©s configurables par service
- **R√©servations** : Confirmation automatique ou manuelle
- **Rappels** : Notifications avant RDV (email/Telegram)
- **Gestion des annulations** : Politique d'annulation flexible

### üí¨ Chat & Support
- **WebSocket** : Communication temps r√©el client-commer√ßant
- **Historique** : Sauvegarde des conversations
- **Notifications** : Alerts Telegram pour nouveaux messages
- **Statuts** : En ligne, absent, occup√©

### üìä Analytics & Recommandations
- **Best-sellers** : Calcul automatique bas√© sur les ventes
- **Produits li√©s** : "Souvent achet√©s ensemble"
- **Rapports** : Ventes par p√©riode, produits populaires
- **KPIs** : Taux de conversion, panier moyen

## Services m√©tier

### ProductService
```python
class ProductService:
    @staticmethod
    def check_stock(product_id: int, quantity: int) -> bool:
        """V√©rifier la disponibilit√© du stock"""
        pass
    
    @staticmethod
    def reserve_stock(product_id: int, quantity: int, order_id: int):
        """R√©server du stock pour une commande"""
        pass
    
    @staticmethod
    def get_related_products(product_id: int, limit: int = 4):
        """Obtenir les produits souvent achet√©s ensemble"""
        pass
```

### OrderService
```python
class OrderService:
    @staticmethod
    def create_order(user_id: int, cart_items: List[CartItem]) -> Order:
        """Cr√©er une commande √† partir du panier"""
        # 1. V√©rifier le stock
        # 2. Calculer le total
        # 3. R√©server les produits
        # 4. Cr√©er la commande
        pass
    
    @staticmethod
    def process_payment(order_id: int, payment_method: str):
        """Traiter le paiement d'une commande"""
        pass
```

### AppointmentService
```python
class AppointmentService:
    @staticmethod
    def get_available_slots(service_id: int, date: date) -> List[datetime]:
        """Obtenir les cr√©neaux disponibles"""
        pass
    
    @staticmethod
    def book_appointment(user_id: int, service_id: int, slot: datetime):
        """R√©server un cr√©neau"""
        pass
```

## R√®gles m√©tier importantes

### Stock et Inventory
- Le stock est r√©serv√© pendant 15 minutes lors de l'ajout au panier
- Les r√©servations expirent automatiquement
- Notifications automatiques quand stock < seuil minimum

### Pricing
- Prix HT/TTC configurables par produit
- Codes promo avec conditions (montant min, validit√©, usage unique)
- Livraison gratuite au-dessus d'un certain montant

### User Experience
- Panier persistant entre sessions (localStorage + DB)
- Recommandations bas√©es sur l'historique d'achat
- Wishlist avec notifications de baisse de prix

### Notifications
- Email de confirmation de commande
- SMS/Telegram pour rappels de RDV
- Notifications push pour les promotions

## Constantes m√©tier
```python
# Dur√©es
CART_RESERVATION_MINUTES = 15
ORDER_CANCELLATION_HOURS = 24
APPOINTMENT_REMINDER_HOURS = 24

# Limites
MAX_CART_ITEMS = 50
MAX_PRODUCT_QUANTITY = 99
FREE_SHIPPING_THRESHOLD = 50.00

# Statuts
class OrderStatus(str, Enum):
    PENDING = "pending"
    PAID = "paid"
    PROCESSING = "processing"
    SHIPPED = "shipped"
    DELIVERED = "delivered"
    CANCELLED = "cancelled"
    REFUNDED = "refunded"

class AppointmentStatus(str, Enum):
    PENDING = "pending"
    CONFIRMED = "confirmed"
    COMPLETED = "completed"
    CANCELLED = "cancelled"
    NO_SHOW = "no_show"
```

## Int√©grations externes

### Stripe
- Webhooks pour synchronisation automatique
- Idempotence sur les paiements
- Gestion des √©checs de paiement

### Telegram Bot
- Notifications temps r√©el des nouvelles commandes
- Alerts pour messages chat
- Rapports quotidiens de ventes

### Email
- Templates HTML responsive
- Queue d'envoi avec retry automatique
- Tracking d'ouverture et clics

## T√¢ches Celery
Les t√¢ches asynchrones sont dans [worker/tasks/](mdc:worker/tasks/) :
- Envoi d'emails
- Synchronisation Stripe
- G√©n√©ration de rapports
- Nettoyage des donn√©es

## S√©curit√© m√©tier
- Validation des permissions utilisateur
- Rate limiting sur les API sensibles
- Audit trail des actions importantes
- Chiffrement des donn√©es sensibles

## Performance
- Cache Redis pour les donn√©es fr√©quemment acc√©d√©es
- Pagination sur toutes les listes
- Optimisation des requ√™tes N+1
- CDN pour les images produits