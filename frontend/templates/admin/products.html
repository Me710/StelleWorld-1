{% extends "admin/base.html" %}

{% block title %}Gestion des Produits{% endblock %}
{% block page_title %}Gestion des Produits{% endblock %}

{% block content %}
<div x-data="productsManager()" x-init="init()" class="space-y-6">
    
    <!-- En-tête avec actions -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div class="flex items-center space-x-4">
            <!-- Recherche -->
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
                <input x-model="search" 
                       @input="searchProducts()"
                       type="search" 
                       placeholder="Rechercher un produit..."
                       class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <!-- Filtres -->
            <select x-model="filters.category" @change="filterProducts()" class="block w-40 px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                <option value="">Toutes catégories</option>
                <template x-for="category in categories" :key="category.id">
                    <option :value="category.id" x-text="category.name"></option>
                </template>
            </select>

            <select x-model="filters.status" @change="filterProducts()" class="block w-32 px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                <option value="">Tous</option>
                <option value="true">Actif</option>
                <option value="false">Inactif</option>
            </select>

            <label class="flex items-center">
                <input x-model="filters.lowStock" @change="filterProducts()" type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600">
                <span class="ml-2 text-sm text-gray-700">Stock faible uniquement</span>
            </label>
        </div>

        <div class="flex space-x-2">
            <button @click="exportProducts()" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Exporter
            </button>
            <a href="/admin/products/create" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Nouveau produit
            </a>
        </div>
    </div>

    <!-- Tableau des produits -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="min-w-full divide-y divide-gray-200">
            <div class="bg-gray-50">
                <div class="grid grid-cols-12 gap-4 px-6 py-3">
                    <div class="col-span-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produit</div>
                    <div class="col-span-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catégorie</div>
                    <div class="col-span-1 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Prix</div>
                    <div class="col-span-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</div>
                    <div class="col-span-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ventes</div>
                    <div class="col-span-1 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</div>
                    <div class="col-span-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</div>
                </div>
            </div>
            
            <div class="divide-y divide-gray-200">
                <template x-for="product in products" :key="product.id">
                    <div class="grid grid-cols-12 gap-4 px-6 py-4 hover:bg-gray-50">
                        <div class="col-span-4 flex items-center">
                            <div class="flex-shrink-0 h-12 w-12">
                                <img x-show="product.main_image_url" 
                                     :src="product.main_image_url" 
                                     :alt="product.name"
                                     class="h-12 w-12 rounded-lg object-cover">
                                <div x-show="!product.main_image_url" 
                                     class="h-12 w-12 rounded-lg bg-gray-200 flex items-center justify-center">
                                    <svg class="h-6 w-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900" x-text="product.name"></div>
                                <div class="text-sm text-gray-500" x-text="'#' + product.id"></div>
                            </div>
                        </div>
                        
                        <div class="col-span-2 flex items-center">
                            <span class="text-sm text-gray-900" x-text="product.category || 'Sans catégorie'"></span>
                        </div>
                        
                        <div class="col-span-1 flex items-center justify-end">
                            <span class="text-sm font-medium text-gray-900" x-text="formatCurrency(product.price)"></span>
                        </div>
                        
                        <div class="col-span-1 flex items-center justify-center">
                            <span :class="getStockClass(product.stock_quantity)" 
                                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                  x-text="product.stock_quantity">
                            </span>
                        </div>
                        
                        <div class="col-span-1 flex items-center justify-center">
                            <span class="text-sm text-gray-900" x-text="product.sales_count || 0"></span>
                        </div>
                        
                        <div class="col-span-1 flex items-center justify-center">
                            <span :class="product.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                  x-text="product.is_active ? 'Actif' : 'Inactif'">
                            </span>
                        </div>
                        
                        <div class="col-span-2 flex items-center justify-end space-x-2">
                            <button @click="editProduct(product)" 
                                    class="text-indigo-600 hover:text-indigo-900 text-sm font-medium">
                                Modifier
                            </button>
                            <button @click="duplicateProduct(product)" 
                                    class="text-blue-600 hover:text-blue-900 text-sm font-medium">
                                Dupliquer
                            </button>
                            <button @click="deleteProduct(product)" 
                                    class="text-red-600 hover:text-red-900 text-sm font-medium">
                                Supprimer
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Pagination -->
        <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200">
            <div class="flex-1 flex justify-between sm:hidden">
                <button @click="previousPage()" 
                        :disabled="currentPage <= 1"
                        class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                    Précédent
                </button>
                <button @click="nextPage()" 
                        :disabled="currentPage >= totalPages"
                        class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                    Suivant
                </button>
            </div>
            
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Affichage de <span class="font-medium" x-text="(currentPage - 1) * itemsPerPage + 1"></span> à 
                        <span class="font-medium" x-text="Math.min(currentPage * itemsPerPage, totalItems)"></span> sur 
                        <span class="font-medium" x-text="totalItems"></span> résultats
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                        <button @click="previousPage()" 
                                :disabled="currentPage <= 1"
                                class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                            Précédent
                        </button>
                        
                        <template x-for="page in visiblePages" :key="page">
                            <button @click="goToPage(page)" 
                                    :class="page === currentPage ? 'bg-indigo-50 border-indigo-500 text-indigo-600' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'"
                                    class="relative inline-flex items-center px-4 py-2 border text-sm font-medium"
                                    x-text="page">
                            </button>
                        </template>
                        
                        <button @click="nextPage()" 
                                :disabled="currentPage >= totalPages"
                                class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                            Suivant
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de suppression -->
    <div x-show="showDeleteModal" x-cloak class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" id="delete-modal">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.268 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mt-2">Supprimer le produit</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        Êtes-vous sûr de vouloir supprimer ce produit ? Cette action ne peut pas être annulée.
                    </p>
                </div>
                <div class="flex justify-center space-x-4 mt-4">
                    <button @click="showDeleteModal = false" 
                            class="px-4 py-2 bg-gray-300 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-400">
                        Annuler
                    </button>
                    <button @click="confirmDelete()" 
                            class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700">
                        Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function productsManager() {
        return {
            products: [],
            categories: [],
            search: '',
            filters: {
                category: '',
                status: '',
                lowStock: false
            },
            currentPage: 1,
            itemsPerPage: 20,
            totalItems: 0,
            totalPages: 0,
            showDeleteModal: false,
            productToDelete: null,
            
            async init() {
                await this.loadCategories();
                await this.loadProducts();
            },
            
            async loadCategories() {
                try {
                    const data = await apiCall('/admin/categories');
                    this.categories = data.categories;
                } catch (error) {
                    console.error('Erreur lors du chargement des catégories:', error);
                }
            },
            
            async loadProducts() {
                try {
                    const params = new URLSearchParams({
                        skip: (this.currentPage - 1) * this.itemsPerPage,
                        limit: this.itemsPerPage
                    });
                    
                    if (this.search) params.append('search', this.search);
                    if (this.filters.category) params.append('category_id', this.filters.category);
                    if (this.filters.status !== '') params.append('is_active', this.filters.status);
                    if (this.filters.lowStock) params.append('low_stock', 'true');
                    
                    const data = await apiCall(`/admin/products?${params}`);
                    this.products = data.products;
                    this.totalItems = data.total;
                    this.totalPages = Math.ceil(this.totalItems / this.itemsPerPage);
                } catch (error) {
                    console.error('Erreur lors du chargement des produits:', error);
                }
            },
            
            async searchProducts() {
                this.currentPage = 1;
                await this.loadProducts();
            },
            
            async filterProducts() {
                this.currentPage = 1;
                await this.loadProducts();
            },
            
            editProduct(product) {
                window.location.href = `/admin/products/${product.id}/edit`;
            },
            
            duplicateProduct(product) {
                window.location.href = `/admin/products/create?duplicate=${product.id}`;
            },
            
            deleteProduct(product) {
                this.productToDelete = product;
                this.showDeleteModal = true;
            },
            
            async confirmDelete() {
                try {
                    await apiCall(`/admin/products/${this.productToDelete.id}`, {
                        method: 'DELETE'
                    });
                    
                    this.showDeleteModal = false;
                    this.productToDelete = null;
                    await this.loadProducts();
                } catch (error) {
                    console.error('Erreur lors de la suppression:', error);
                    alert('Erreur lors de la suppression du produit');
                }
            },
            
            async exportProducts() {
                try {
                    const response = await fetch('/api/admin/products/export', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                        }
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `products-${new Date().toISOString().split('T')[0]}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }
                } catch (error) {
                    console.error('Erreur lors de l\'export:', error);
                }
            },
            
            formatCurrency(amount) {
                return new Intl.NumberFormat('fr-FR', {
                    style: 'currency',
                    currency: 'EUR'
                }).format(amount);
            },
            
            getStockClass(stock) {
                if (stock === 0) return 'bg-red-100 text-red-800';
                if (stock <= 10) return 'bg-yellow-100 text-yellow-800';
                return 'bg-green-100 text-green-800';
            },
            
            get visiblePages() {
                const delta = 2;
                const range = [];
                const rangeWithDots = [];
                
                for (let i = Math.max(2, this.currentPage - delta);
                     i <= Math.min(this.totalPages - 1, this.currentPage + delta);
                     i++) {
                    range.push(i);
                }
                
                if (this.currentPage - delta > 2) {
                    rangeWithDots.push(1, '...');
                } else {
                    rangeWithDots.push(1);
                }
                
                rangeWithDots.push(...range);
                
                if (this.currentPage + delta < this.totalPages - 1) {
                    rangeWithDots.push('...', this.totalPages);
                } else if (this.totalPages > 1) {
                    rangeWithDots.push(this.totalPages);
                }
                
                return rangeWithDots.filter(page => page !== '...' || rangeWithDots.indexOf(page) === rangeWithDots.lastIndexOf(page));
            },
            
            previousPage() {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    this.loadProducts();
                }
            },
            
            nextPage() {
                if (this.currentPage < this.totalPages) {
                    this.currentPage++;
                    this.loadProducts();
                }
            },
            
            goToPage(page) {
                if (page !== '...' && page !== this.currentPage) {
                    this.currentPage = page;
                    this.loadProducts();
                }
            }
        }
    }
</script>
{% endblock %}
